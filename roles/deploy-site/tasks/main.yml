---
- name: Create vhost conf (Apache)
  template: 
    src: templates/vhost.conf.j2 
    dest: /etc/apache2/sites-available/{{ item.key }}.conf
  with_dict: "{{ sites }}"
  notify: restart apache

- name: Enable the site (Apache)
  file:
    src: /etc/apache2/sites-available/{{ item.key }}.conf
    dest: /etc/apache2/sites-enabled/{{ item.key }}.conf
    state: link
  with_dict: "{{ sites }}"
  notify: restart apache

# This will return 200 in repo_check.results.item.status if the repo exists, 404 if not
- name: Check if a repo exists on git.megaphonetech.com
  uri:
    url: https://git.megaphonetech.com/api/v1/repos/{{ item.value.git_repo_owner + '/' + item.value.git_repo_name }}
    headers:
      Authorization: token {{ lookup('passwordstore', 'megaphone/gogs/api') }}
  with_dict: "{{ sites }}"
  register: repo_check
  failed_when: false

# For internal (git.megaphonetech.com) repos
- include_tasks: internal-git.yml
  with_items: "{{ repo_check.results }}"
  become_user: "{{ ansible_user }}"
  when: item.status == 200
