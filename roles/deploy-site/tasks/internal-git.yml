- name: Get the home directory
  user:
    name: "{{ ansible_user }}"
  register: userinfo

- name: Get the Ansible user's SSH key
  slurp:
    src: "{{ userinfo.home }}/.ssh/id_rsa.pub"
  become: no
  register: key

- name: Set up deploy keys on gogs
  uri:
    url: https://git.megaphonetech.com/api/v1/repos/{{ item.value.git_repo_owner + '/' + item.value.git_repo_name }}/keys
    method: POST
    body_format: json
    body:
      title: "{{ ansible_user + '@' + inventory_hostname_short }}"
      key: "{{ key['content'] | b64decode }}"
    headers:
      Authorization: token {{ lookup('passwordstore', 'megaphone/gogs/api') }}
  register: gogs_result
  changed_when: gogs_result.status == 201
  failed_when: gogs_result.status != 201 and not (gogs_result.json.message is defined and gogs_result.json.message | search("public key already exists"))

- name: Add gogs keys to Ansible user known_hosts
  known_hosts:
    name: "[git.megaphonetech.com]:10022"
    key: "{{ inner_item }}" 
  loop_control:
    loop_var: inner_item
  with_items:
    - "[git.megaphonetech.com]:10022 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDgNwIe3TBtRHtkwoHL2TG84/f039hgzqVbN0z4sk1UHPZr4rxFinGCGjedzE+adVucqr/gemPnETfashTujcPyZZkwPn2dQNx0HuPHw3H+cqXqKt03fsgPcerqsqvFS509pcblmP5vtJLF4uVgbh6TLmZiObMuiIYe9VTyZSXo67DTt/K6SSgwyUFldqJIJQA+DO1nXoSYSJ4fP1DDPdue0RTL06VtlnUL2w9iHrOgVRY1KqAtpnGRslKx5c3L8+9EBMdJWM1CPK11vkvyf8LnYwuCH4V7w0rVs2QAE9Abm4g4HiE4wql5QJrjCi/cq/1doeY9KXxFb8SOTtZBk5Nn"
    - "[git.megaphonetech.com]:10022 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLuEP2fW8Eycdbeo0XWihr63zj6yCTcCjxh4C4i3c8p2O44mKRjVhxOSSBQQxZNUKeJYAGTuWh+EPW71KADzXv0="
    - "[git.megaphonetech.com]:10022 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJoN1UsqLqucSJo4dSum6Xy2qCrlutDAu3wPdprAL4w"
      
- name: Create the folder hierarchy
  file:
    path: "{{ item.value.gitroot }}"
    state: directory
    mode: 02770
#    recurse: yes
    owner: "{{ ansible_user }}"
    group: "{{ item.value.run_as_user }}"
  become_user: root

#TODO: Sometimes we're making a new site
- name: clone an existing site
  git:
    repo: "{{ item.value.git_repo_url }}"
    dest: "{{ item.value.gitroot }}"
    version: master
    umask: "0007"
